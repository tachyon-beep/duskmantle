name: Neo4j Integration Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * *"

jobs:
  neo4j-tests:
    runs-on: ubuntu-latest
    env:
      NEO4J_TEST_URI: bolt://localhost:7687
      NEO4J_TEST_USER: neo4j
      NEO4J_TEST_PASSWORD: temp-password
    services:
      neo4j:
        image: neo4j:5
        ports:
          - 7687:7687
        env:
          NEO4J_AUTH: neo4j/temp-password
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 12

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -e .[dev]

      - name: Wait for Neo4j
        run: |
          for i in {1..30}; do
            if echo 'RETURN 1' | cypher-shell -a bolt://localhost:7687 -u neo4j -p temp-password >/dev/null 2>&1; then
              exit 0
            fi
            sleep 2
          done
          echo "Neo4j did not become ready in time" >&2
          exit 1
        env:
          NEO4J_HOME: /var/lib/neo4j
        shell: bash

      - name: Run Neo4j integration tests
        run: |
          . .venv/bin/activate
          pytest -m neo4j -ra
