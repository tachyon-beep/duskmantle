# Search Observability Dashboard Playbook

This guide walks through the completed rollout of search-specific monitoring. Each stage maps to the agreed plan and includes actionable artifacts (metric inventory, SLOs, PromQL, and alert hooks) to accelerate dashboard implementation.

## 1. Metric Inventory

| Metric | Type | Labels | Notes |
| ------ | ---- | ------ | ----- |
| `km_search_graph_cache_events_total` | Counter | `status` (`hit`, `miss`, `error`) | Emits one increment per artifact per query. A single search with repeated hits reuses cached context so you should only see one miss followed by hits. |
| `km_search_graph_lookup_seconds` | Histogram | _none_ | Latency buckets auto-generated by Prometheus client; use `_bucket`, `_sum`, `_count`. |
| `km_search_adjusted_minus_vector` | Histogram | _none_ | Captures the delta between adjusted and raw vector scores per result. |
| `km_search_requests_total` | Counter | `status` | Useful for normalising hit ratios and delta trends. |
| `km_graph_migration_last_status` / `_timestamp` | Gauge | _none_ | Use alongside search panels to catch failed or stale migrations quickly. |

## 2. SLO Thresholds (Initial Targets)

- **Cache Hit Ratio:** ≥85% of lookups should be hits. Investigate when hits / (hits + misses) < 0.85.
- **Lookup Latency:** P95 of `km_search_graph_lookup_seconds` ≤ 250 ms for prod; warning at 200 ms, critical at 250 ms.
- **Ranking Delta Band:** Mean of `km_search_adjusted_minus_vector` should stay within ±0.2. Sustained deviation indicates weighting drift.

## 3. Panel Sketches

1. **Cache Utilisation (Stacked Bar):** hits vs misses vs errors per 5 min. Overlay hit ratio.
2. **Neo4j Lookup Latency (Heatmap + Percentile):** heatmap of bucket counts plus P95/P99 line chart.
3. **Ranking Delta Distribution:** histogram of delta buckets with moving average line.
4. **Search Volume Sparkline:** `km_search_requests_total` success/failure stacked area for context.
5. **Latency Diagnostics Table:** top searches by lookup latency (requires log/trace integration). Optional initial placeholder.

## 4. PromQL Snippets

```promql
# Cache hit ratio (5m sliding window)
(sum by () (increase(km_search_graph_cache_events_total{status="hit"}[5m]))) /
clamp_min(sum by () (increase(km_search_graph_cache_events_total{status=~"hit|miss"}[5m])), 1)

# Cache error rate
sum(increase(km_search_graph_cache_events_total{status="error"}[5m]))

# Lookup P95
histogram_quantile(0.95, sum(rate(km_search_graph_lookup_seconds_bucket[5m])) by (le))

# Ranking delta moving average (5m)
avg_over_time(km_search_adjusted_minus_vector_sum[5m]) / avg_over_time(km_search_adjusted_minus_vector_count[5m])

# Search request volume (success/failure)
sum by (status) (increase(km_search_requests_total[5m]))
```

## 5. Grafana Implementation Notes

- Template variables: `environment` (e.g., prod/staging) using Prometheus label filters and optional `project`.
- Organise panels into rows: **Search Health** (cache, latency, volume) and **Ranking Drift** (delta distribution, moving average).
- Suggested visualization types:
  - Stacked bar + stat for hit ratio.
  - Heatmap + stat for lookup histogram.
  - Histogram (new in Grafana 10) for delta distribution, plus time-series line for mean.
- Exported dashboard JSON should retain PromQL above; store in `infra/grafana/search_observability.json` when ready (placeholder for future automation).

## 6. Alert Rules (Prometheus Example)

```yaml
- alert: SearchGraphCacheHitRatioLow
  expr: 1 - (sum(increase(km_search_graph_cache_events_total{status="hit"}[10m])) /
             clamp_min(sum(increase(km_search_graph_cache_events_total{status=~"hit|miss"}[10m])), 1)) > 0.15
  for: 15m
  labels:
    severity: warning
  annotations:
    summary: "Search graph cache hit ratio below 85%"
    runbook: "https://…/docs/OBSERVABILITY_GUIDE.md#search-graph-cache"

- alert: SearchGraphLookupLatencyHigh
  expr: histogram_quantile(0.95, sum(rate(km_search_graph_lookup_seconds_bucket[5m])) by (le)) > 0.25
  for: 10m
  labels:
    severity: critical
  annotations:
    summary: "Search graph lookup P95 latency >250ms"
    runbook: "https://…/docs/OBSERVABILITY_GUIDE.md#search-graph-latency"

- alert: SearchRankingDeltaDrift
  expr: abs(avg_over_time(km_search_adjusted_minus_vector_sum[15m]) /
            clamp_min(avg_over_time(km_search_adjusted_minus_vector_count[15m]), 1)) > 0.2
  for: 30m
  labels:
    severity: warning
  annotations:
    summary: "Ranking delta drift detected"
    runbook: "https://…/docs/OBSERVABILITY_GUIDE.md#ranking-drift"
```

## 7. Runbook & Review

- **Documentation:** See updated entries in `docs/OBSERVABILITY_GUIDE.md` (dashboard & alert cookbook) and `STATUS.md` for project status.
- **Stakeholder Review:** Schedule a 30-minute review with SRE + applied ML team to validate thresholds after one week of data. Capture decisions in `docs/OBSERVABILITY_GUIDE.md#review-log` (placeholder section added).
- **Next Steps:** Once Grafana dashboard is deployed, export JSON to repo and automate provisioning via Terraform or Grafana provisioning config.
